import fitz, base64, requests, json, os, time; from io import BytesIO; from PIL import Image; from datetime import datetime; pdf_path="knowledge_data/ã€02ã€‘å€ªæµ·å¦æ–‡æ¡£å…¨é›†-å¯æ‰“å°ï¼ˆ24æœ¬ï¼‰/å¿«ä¹ç”Ÿæ´»çš„é—®è¯Šå•.pdf"; API_KEY="sk-qnczgrftmuzuyhyfdroapmqqqnefqpvbwtjikrnlbzbimpkw"; MODEL="Qwen/Qwen2.5-VL-72B-Instruct"; doc=fitz.open(pdf_path); total_pages=len(doc); doc.close(); print(f"å¼€å§‹å¤„ç†{total_pages}é¡µPDF"); kb={"document":{"filename":os.path.basename(pdf_path),"total_pages":total_pages,"model":MODEL,"processed_date":datetime.now().isoformat()},"pages":[],"full_content":"","stats":{"success":0,"failed":0,"total_chars":0}}; start_time=time.time(); [print(f"\n[{i+1}/{total_pages}] å¤„ç†ç¬¬{i+1}é¡µ") or exec("doc=fitz.open(pdf_path); page=doc[i]; pix=page.get_pixmap(matrix=fitz.Matrix(2.0,2.0)); img_data=pix.tobytes(\\"png\\"); pil_img=Image.open(BytesIO(img_data)); buffer=BytesIO(); pil_img.save(buffer,format=\\"PNG\\"); b64=base64.b64encode(buffer.getvalue()).decode(); doc.close(); data={\\"model\\":MODEL,\\"messages\\":[{\\"role\\":\\"user\\",\\"content\\":[{\\"type\\":\\"text\\",\\"text\\":\\"è¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„æ‰€æœ‰ä¸­æ–‡æ–‡å­—ï¼Œç›´æ¥è¾“å‡ºæ–‡å­—å†…å®¹ï¼š\\"},{\\"type\\":\\"image_url\\",\\"image_url\\":{\\"url\\":f\\"data:image/png;base64,{b64}\\"}}]}],\\"max_tokens\\":4000,\\"temperature\\":0.1}; r=requests.post(\\"https://api.siliconflow.cn/v1/chat/completions\\",headers={\\"Authorization\\":\\"Bearer \\"+API_KEY,\\"Content-Type\\":\\"application/json\\"},json=data,timeout=60); content=r.json().get(\\"choices\\",[{}])[0].get(\\"message\\",{}).get(\\"content\\",\\"\\"); kb[\\"pages\\"].append({\\"page\\":i+1,\\"content\\":content,\\"chars\\":len(content)}); kb[\\"stats\\"][\\"success\\"]+=1; kb[\\"stats\\"][\\"total_chars\\"]+=len(content); kb[\\"full_content\\"]+=f\\"\\n\\n=== ç¬¬{i+1}é¡µ ===\\n{content}\\"; print(f\\"  âœ… æˆåŠŸ {len(content)}å­—ç¬¦\\"); time.sleep(1.5) if i<total_pages-1 else None") for i in range(total_pages)]; kb["stats"]["processing_time"]=round(time.time()-start_time,2); kb["full_content"]=kb["full_content"].strip(); json.dump(kb,open("å¿«ä¹ç”Ÿæ´»é—®è¯Šå•_knowledge_base.json","w",encoding="utf-8"),ensure_ascii=False,indent=2); open("å¿«ä¹ç”Ÿæ´»é—®è¯Šå•_content.txt","w",encoding="utf-8").write(f"å¿«ä¹ç”Ÿæ´»çš„é—®è¯Šå• - AIçŸ¥è¯†åº“\nå¤„ç†æ—¶é—´: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}\næ€»å­—ç¬¦æ•°: {kb[\"stats\"][\"total_chars\"]}\næ€»é¡µæ•°: {total_pages}\næˆåŠŸ: {kb[\"stats\"][\"success\"]}\nç”¨æ—¶: {kb[\"stats\"][\"processing_time\"]}ç§’\n\n{\"=\"*80}\n\n{kb[\"full_content\"]}"); print(f"\nğŸ‰ å¤„ç†å®Œæˆ! æ€»å­—ç¬¦æ•°: {kb[\"stats\"][\"total_chars\"]}, ç”¨æ—¶: {kb[\"stats\"][\"processing_time\"]}ç§’\nğŸ’¾ æ–‡ä»¶: å¿«ä¹ç”Ÿæ´»é—®è¯Šå•_knowledge_base.json, å¿«ä¹ç”Ÿæ´»é—®è¯Šå•_content.txt")
